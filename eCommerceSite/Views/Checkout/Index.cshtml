@model CheckoutViewModel
@{
    ViewData["Title"] = "Checkout";
}

@if (!ViewData.ModelState.IsValid)
{<div class="alert-danger">
    @Html.ValidationSummary(false)
</div>
}

<h2>Checkout</h2>
<form method="post" id="checkoutForm">
    <div class="form-group">
        <label asp-for="Email" class="control-label">Email</label>
        <input type="email" asp-for="Email" class="form-control" placeholder="example@domain.com" required />
    </div>
    <div class="form-group">
        <label asp-for="PhoneNumber" class="control-label">Phone Number</label>
        <input type="tel" asp-for="PhoneNumber" class="form-control" placeholder="(000)000-0000" required />
    </div>
    <div class="form-group">
        <label asp-for="Street1" class="control-label">Address Line 1</label>
        <input type="text" asp-for="Street1" class="form-control" placeholder="222 N Example Ave" required />
    </div>
    <div class="form-group">
        <label asp-for="Street2" class="control-label">Address Line 2 (optional)</label>
        <input type="text" asp-for="Street2" class="form-control" placeholder="ex: Unit 2S, Apartment 3B, etc." />
    </div>
    <div class="form-group">
        <label asp-for="City" class="control-label">City</label>
        <input type="text" asp-for="City" class="form-control" placeholder="City Name" required />
    </div>
    <div class="form-group">
        <label asp-for="State" class="control-label">State</label>
        <input type="text" asp-for="State" class="form-control" placeholder="State Abbreviation" required />
    </div>
    <div class="form-group">
        <label asp-for="PostalCode" class="control-label">Postal Code</label>
        <input type="text" asp-for="PostalCode" class="form-control" placeholder="ex: 90210" required />
    </div>
    <div class="form-group">
        <label asp-for="Recipient" class="control-label">Recipient Name (optional)</label>
        <input type="text" asp-for="Recipient" class="form-control" placeholder="Recipient Name" />
    </div>
    <div class="form-group">
        <label asp-for="Instructions" class="control-label">Delivery Insturctions (optional)</label>
        <input type="text" asp-for="Instructions" class="form-control" placeholder="ex: ring last doorbell, knock 4 times, etc" />
    </div>
    <div class="form-group">
        <label for="card-number">Card Number</label>
        <div class="form-control" id="card-number"></div>
    </div>
    <div class="form-group">
        <label for="cvv">CVV</label>
        <div class="form-control" id="cvv"></div>
    </div>
    <div class="form-group">
        <label for="expiration-date">Expiration Date</label>
        <div class="form-control" id="expiration-date"></div>
    </div>
    <input type="hidden" id="braintree-nonce" name="braintreeNonce" />


    <button class="btn btn-primary">Place Order</button>
</form>

@section Scripts{
    <script src="https://js.braintreegateway.com/web/3.42.0/js/client.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.42.0/js/hosted-fields.min.js"></script>
    <script type="text/javascript">
        braintree.client.create({
            authorization: '@ViewBag.BraintreeClientToken'
        }, function (clientErr, clientInstance) {
            if (clientErr) {
                console.error(clientErr);
                return;
            }
            braintree.hostedFields.create({
                client: clientInstance,
                styles: {
                    'input.invalid': {
                        'color': 'red'
                    },
                    'input.valid': {
                        'color': 'green'
                    }
                },
                fields: {
                    number: {
                        selector: '#card-number',
                        placeholder: '4111 1111 1111 1111'
                    },
                    cvv: {
                        selector: '#cvv',
                        placeholder: '123'
                    },
                    expirationDate: {
                        selector: '#expiration-date',
                        placeholder: '10/2019'
                    }
                }
            }, function (hostedFieldsErr, hostedFieldsInstance) {
                    if (hostedFieldsErr) {
                    console.error(hostedFieldsErr);
                    return;
                }
                    var form = document.querySelector("#checkoutForm");
                    form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    hostedFieldsInstance.tokenize(function (tokenizeErr, payload) {
                        if (tokenizeErr) {
                            console.error(tokenizeErr);
                        }
                        document.querySelector('#braintree-nonce').value = payload.nonce;
                        //console.log('Got a nonce: ' + payload.nonce);
                        form.submit();
                    });
                }, false);
            });
        });
    </script>
}
